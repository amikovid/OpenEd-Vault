<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEO Content Pipeline - Kanban</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --border: #1a3a5c;
    --text: #e0e0e0;
    --text-dim: #8899aa;
    --accent: #e94560;
    --green: #2ecc71;
    --blue: #3498db;
    --orange: #e67e22;
    --purple: #9b59b6;
    --teal: #1abc9c;
    --yellow: #f1c40f;
    --col-research: #6c5ce7;
    --col-drafting: #0984e3;
    --col-review: #e67e22;
    --col-ready: #00b894;
    --col-published: #2ecc71;
    --col-archived: #636e72;
    --radius: 8px;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: auto;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header h1 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  .header-stats {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: var(--text-dim);
  }
  .header-stats .stat-val { color: var(--text); font-weight: 600; }
  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* Buttons */
  button {
    font-family: inherit;
    cursor: pointer;
    border: none;
    border-radius: var(--radius);
    font-size: 13px;
    padding: 6px 14px;
    transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #d63851; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-sm { padding: 4px 10px; font-size: 12px; }
  .btn-icon {
    background: none;
    color: var(--text-dim);
    padding: 4px;
    font-size: 16px;
    line-height: 1;
  }
  .btn-icon:hover { color: var(--text); }

  /* Board */
  .board {
    display: flex;
    gap: 12px;
    padding: 16px 24px;
    min-height: calc(100vh - 60px);
    overflow-x: auto;
  }

  /* Columns */
  .column {
    min-width: 280px;
    max-width: 320px;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .column-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    border-bottom: 2px solid var(--border);
    gap: 8px;
  }
  .column-header .col-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .column-header h2 {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex: 1;
  }
  .column-header .count {
    font-size: 12px;
    color: var(--text-dim);
    background: var(--bg);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .column-body {
    flex: 1;
    padding: 8px;
    overflow-y: auto;
    min-height: 100px;
  }
  .column-body.drag-over {
    background: rgba(233, 69, 96, 0.08);
    outline: 2px dashed var(--accent);
    outline-offset: -4px;
  }

  /* Cards */
  .card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.15s;
    position: relative;
  }
  .card:active { cursor: grabbing; }
  .card:hover { border-color: var(--accent); }
  .card.dragging { opacity: 0.4; transform: scale(0.97); }
  .card-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 6px;
    line-height: 1.3;
    padding-right: 24px;
  }
  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 6px;
  }
  .badge {
    font-size: 10px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .badge-thinkers { background: rgba(155,89,182,0.2); color: #c39bd3; }
  .badge-deepdive { background: rgba(52,152,219,0.2); color: #7fb3e0; }
  .badge-comparison { background: rgba(230,126,34,0.2); color: #e8a87c; }
  .badge-versus { background: rgba(233,69,96,0.2); color: #e9a0ad; }
  .badge-state { background: rgba(26,188,156,0.2); color: #76d7c4; }
  .badge-guide { background: rgba(241,196,15,0.2); color: #f4d35e; }
  .badge-hub { background: rgba(108,92,231,0.2); color: #a29bfe; }
  .badge-draft {
    background: rgba(255,255,255,0.06);
    color: var(--text-dim);
    font-weight: 400;
  }
  .card-keyword {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }
  .card-keyword::before { content: ''; }
  .card-note {
    font-size: 11px;
    color: var(--orange);
    margin-top: 4px;
    font-style: italic;
  }
  .card-slug {
    font-size: 11px;
    color: var(--teal);
    font-family: 'SF Mono', 'Fira Code', monospace;
    margin-top: 2px;
  }
  .card-date {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 2px;
  }
  .card-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .card:hover .card-actions { opacity: 1; }

  /* Comments */
  .card-comments {
    margin-top: 8px;
    border-top: 1px solid var(--border);
    padding-top: 6px;
  }
  .comment {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 4px;
    line-height: 1.4;
  }
  .comment-time {
    color: var(--text-dim);
    opacity: 0.6;
    font-size: 10px;
  }
  .comment-text { color: var(--text); }
  .comment-input-wrap {
    display: flex;
    gap: 4px;
    margin-top: 4px;
  }
  .comment-input-wrap input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    padding: 4px 8px;
    font-size: 11px;
    font-family: inherit;
    outline: none;
  }
  .comment-input-wrap input:focus { border-color: var(--accent); }
  .comment-input-wrap input::placeholder { color: var(--text-dim); opacity: 0.5; }
  .comment-toggle {
    font-size: 11px;
    color: var(--text-dim);
    cursor: pointer;
    margin-top: 4px;
    display: inline-block;
  }
  .comment-toggle:hover { color: var(--text); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
  }
  .modal h3 {
    font-size: 16px;
    margin-bottom: 12px;
  }
  .modal textarea {
    width: 100%;
    min-height: 300px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    padding: 12px;
    resize: vertical;
    outline: none;
    tab-size: 2;
  }
  .modal textarea:focus { border-color: var(--accent); }
  .modal-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    justify-content: flex-end;
  }
  .modal p {
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 12px;
    line-height: 1.5;
  }

  /* Add card form */
  .add-card-form {
    background: var(--bg);
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    padding: 10px;
    margin-top: 4px;
  }
  .add-card-form input, .add-card-form select {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    padding: 6px 8px;
    font-size: 12px;
    font-family: inherit;
    margin-bottom: 6px;
    outline: none;
  }
  .add-card-form input:focus, .add-card-form select:focus { border-color: var(--accent); }
  .add-card-btn {
    width: 100%;
    padding: 6px;
    background: none;
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    color: var(--text-dim);
    font-size: 12px;
    cursor: pointer;
    margin-top: 4px;
  }
  .add-card-btn:hover { border-color: var(--accent); color: var(--text); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--green);
    color: #fff;
    padding: 10px 20px;
    border-radius: var(--radius);
    font-size: 13px;
    font-weight: 500;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    z-index: 300;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* Filter bar */
  .filter-bar {
    display: flex;
    gap: 6px;
    padding: 8px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    align-items: center;
  }
  .filter-bar label { font-size: 12px; color: var(--text-dim); margin-right: 4px; }
  .filter-chip {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: none;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-chip:hover { border-color: var(--text-dim); color: var(--text); }
  .filter-chip.active { background: var(--accent); border-color: var(--accent); color: white; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  .delete-comment {
    color: var(--accent);
    cursor: pointer;
    font-size: 10px;
    margin-left: 4px;
    opacity: 0.5;
  }
  .delete-comment:hover { opacity: 1; }
</style>
</head>
<body>

<div class="header">
  <h1>SEO Content Pipeline</h1>
  <div class="header-stats">
    <span><span class="stat-val" id="stat-total">0</span> total</span>
    <span><span class="stat-val" id="stat-active">0</span> active</span>
    <span><span class="stat-val" id="stat-published">0</span> published</span>
  </div>
  <div class="header-actions">
    <button class="btn-secondary btn-sm" onclick="openDataModal()">Sync Data</button>
    <button class="btn-primary btn-sm" onclick="openAddModal()">+ New Card</button>
  </div>
</div>

<div class="filter-bar">
  <label>Filter:</label>
  <button class="filter-chip active" data-filter="all" onclick="setFilter('all',this)">All</button>
  <button class="filter-chip" data-filter="thinkers" onclick="setFilter('thinkers',this)">Thinkers</button>
  <button class="filter-chip" data-filter="deepdive" onclick="setFilter('deepdive',this)">Deep Dive</button>
  <button class="filter-chip" data-filter="comparison" onclick="setFilter('comparison',this)">Comparison</button>
  <button class="filter-chip" data-filter="versus" onclick="setFilter('versus',this)">Versus</button>
  <button class="filter-chip" data-filter="state" onclick="setFilter('state',this)">State Pages</button>
  <button class="filter-chip" data-filter="guide" onclick="setFilter('guide',this)">Guides</button>
</div>

<div class="board" id="board"></div>

<!-- Data sync modal -->
<div class="modal-overlay" id="dataModal">
  <div class="modal">
    <h3>Sync Data with Claude</h3>
    <p>Copy the JSON below and paste it into Claude to share current state. Or paste updated JSON from Claude and click Import to update the board.</p>
    <textarea id="dataTextarea" spellcheck="false"></textarea>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeDataModal()">Close</button>
      <button class="btn-secondary" onclick="copyData()">Copy JSON</button>
      <button class="btn-primary" onclick="importData()">Import JSON</button>
    </div>
  </div>
</div>

<!-- Add card modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Add New Content Card</h3>
    <div class="add-card-form" style="border: none; background: none; padding: 0;">
      <input type="text" id="newTitle" placeholder="Article title">
      <select id="newType">
        <option value="thinkers">Thinkers Series</option>
        <option value="deepdive">Deep Dive</option>
        <option value="comparison">Comparison</option>
        <option value="versus">Versus</option>
        <option value="state">State Page</option>
        <option value="guide">Guide Series</option>
        <option value="hub">Hub Page</option>
      </select>
      <input type="text" id="newKeyword" placeholder="Target keyword">
      <select id="newColumn">
        <option value="research">Research</option>
        <option value="drafting">Drafting</option>
        <option value="review">Review</option>
        <option value="ready">Ready to Publish</option>
        <option value="published">Published</option>
        <option value="archived">Archived</option>
      </select>
      <input type="text" id="newSlug" placeholder="Slug (optional)">
      <input type="text" id="newDraft" placeholder="Draft version (e.g. draft-v1)">
      <input type="text" id="newNote" placeholder="Note (optional)">
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeAddModal()">Cancel</button>
      <button class="btn-primary" onclick="addNewCard()">Add Card</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved!</div>

<script>
const COLUMNS = [
  { id: 'research', title: 'Research', color: 'var(--col-research)' },
  { id: 'drafting', title: 'Drafting', color: 'var(--col-drafting)' },
  { id: 'review', title: 'Review', color: 'var(--col-review)' },
  { id: 'ready', title: 'Ready to Publish', color: 'var(--col-ready)' },
  { id: 'published', title: 'Published', color: 'var(--col-published)' },
  { id: 'archived', title: 'Archived', color: 'var(--col-archived)' }
];

const TYPE_BADGES = {
  thinkers: { label: 'Thinkers', cls: 'badge-thinkers' },
  deepdive: { label: 'Deep Dive', cls: 'badge-deepdive' },
  comparison: { label: 'Comparison', cls: 'badge-comparison' },
  versus: { label: 'Versus', cls: 'badge-versus' },
  state: { label: 'State Page', cls: 'badge-state' },
  guide: { label: 'Guide', cls: 'badge-guide' },
  hub: { label: 'Hub Page', cls: 'badge-hub' }
};

const DEFAULT_DATA = [
  // Archived
  { id: 'gatto', title: 'John Taylor Gatto Profile', type: 'thinkers', column: 'archived', slug: '5369', keyword: 'john taylor gatto', publishedDate: '2024-01-01', comments: [] },
  { id: 'charlotte', title: 'Charlotte Mason Method', type: 'deepdive', column: 'archived', slug: 'charlotte-mason', keyword: 'charlotte mason method', publishedDate: '2026-01-14', comments: [] },
  { id: 'ai-tutoring', title: 'AI Tutoring for Homeschool', type: 'deepdive', column: 'archived', slug: 'ai-tutors-homeschool', keyword: 'ai tutoring homeschool', publishedDate: '2026-01-09', comments: [] },
  { id: 'cte', title: 'Apprenticeships & CTE Guide', type: 'deepdive', column: 'archived', slug: 'apprenticeships-cte-guide', keyword: 'apprenticeships for teens', publishedDate: '2026-01-23', comments: [] },
  { id: 'pbl', title: 'Project-Based Learning Guide', type: 'deepdive', column: 'archived', slug: 'project-based-learning', keyword: 'project based learning', publishedDate: '2026-01-28', comments: [] },
  { id: 'free-curric', title: 'Free Homeschool Curriculum Guide', type: 'deepdive', column: 'archived', slug: 'free-homeschool-curriculum', keyword: 'free homeschool curriculum', publishedDate: '2026-01-28', comments: [] },

  // Ready to Publish
  { id: 'gray', title: 'Peter Gray Profile', type: 'thinkers', column: 'ready', keyword: 'peter gray education', draft: 'draft-v2', comments: [] },
  { id: 'montessori-p', title: 'Maria Montessori Profile', type: 'thinkers', column: 'ready', keyword: 'maria montessori method', draft: 'draft-v2', comments: [] },
  { id: 'greenberg', title: 'Daniel Greenberg Profile', type: 'thinkers', column: 'ready', keyword: 'sudbury school', draft: 'draft-v1', comments: [] },
  { id: 'holt', title: 'John Holt Profile', type: 'thinkers', column: 'ready', keyword: 'john holt unschooling', draft: 'draft-v1', comments: [] },
  { id: 'illich', title: 'Ivan Illich Profile', type: 'thinkers', column: 'ready', keyword: 'ivan illich deschooling', draft: 'draft-v1', comments: [] },

  // Review
  { id: 'mastery', title: 'Mastery-Based Learning Refresh', type: 'deepdive', column: 'review', keyword: 'mastery based learning', draft: 'draft-v3', note: 'Updates existing /blog/beyond-a-to-f', comments: [] },

  // Drafting
  { id: 'waldorf-v-mont', title: 'Waldorf vs Montessori', type: 'comparison', column: 'drafting', keyword: 'waldorf vs montessori', draft: 'draft-v1', note: '2,900/mo KD 0', comments: [] },
  { id: 'mont-v-reggio', title: 'Montessori vs Reggio Emilia', type: 'comparison', column: 'drafting', keyword: 'montessori vs reggio emilia', draft: 'draft-v1', comments: [] },
  { id: 'ixl-exact', title: 'IXL vs Exact Path', type: 'versus', column: 'drafting', keyword: 'ixl vs exact path', draft: 'draft-v2', comments: [] },
  { id: 'khan-ixl', title: 'Khan Academy vs IXL', type: 'versus', column: 'drafting', keyword: 'khan academy vs ixl', draft: 'draft-v1', comments: [] },
  { id: 'saxon-msu', title: 'Saxon vs Math-U-See', type: 'versus', column: 'drafting', keyword: 'saxon vs math u see', draft: 'draft-v1', comments: [] },
  { id: 'oregon', title: 'Oregon Homeschool Guide', type: 'state', column: 'drafting', keyword: 'oregon homeschool', draft: 'draft-v2', comments: [] },
  { id: 'utah', title: 'Utah Homeschool Guide', type: 'state', column: 'drafting', keyword: 'utah homeschool', draft: 'draft-v1', comments: [] },

  // Research
  { id: 'grade-guides', title: 'Grade Level Guides', type: 'guide', column: 'research', keyword: 'TBD', note: 'PROJECT.md only', comments: [] },
  { id: 'thinkers-hub', title: 'Thinkers Hub Page', type: 'hub', column: 'research', keyword: 'pioneers of open education', note: 'Not started', comments: [] },
  { id: 'waldorf-solo', title: 'Waldorf Education', type: 'deepdive', column: 'research', keyword: 'waldorf education', note: 'SEO brief only', comments: [] }
];

// State
let cards = [];
let activeFilter = 'all';
let draggedId = null;

// Init
function init() {
  const saved = localStorage.getItem('seo-pipeline-kanban');
  if (saved) {
    try { cards = JSON.parse(saved); } catch(e) { cards = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
  } else {
    cards = JSON.parse(JSON.stringify(DEFAULT_DATA));
  }
  render();
}

function save() {
  localStorage.setItem('seo-pipeline-kanban', JSON.stringify(cards));
  updateStats();
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Render
function render() {
  const board = document.getElementById('board');
  board.innerHTML = '';

  COLUMNS.forEach(col => {
    const colCards = cards.filter(c => c.column === col.id);
    const filteredCards = activeFilter === 'all' ? colCards : colCards.filter(c => c.type === activeFilter);

    const colEl = document.createElement('div');
    colEl.className = 'column';
    colEl.innerHTML = `
      <div class="column-header">
        <div class="col-indicator" style="background:${col.color}"></div>
        <h2>${col.title}</h2>
        <span class="count">${colCards.length}</span>
      </div>
      <div class="column-body" data-column="${col.id}"></div>
    `;

    const body = colEl.querySelector('.column-body');

    // Drag events on column
    body.addEventListener('dragover', e => { e.preventDefault(); body.classList.add('drag-over'); });
    body.addEventListener('dragleave', e => { if (!body.contains(e.relatedTarget)) body.classList.remove('drag-over'); });
    body.addEventListener('drop', e => {
      e.preventDefault();
      body.classList.remove('drag-over');
      if (draggedId) {
        const card = cards.find(c => c.id === draggedId);
        if (card && card.column !== col.id) {
          const oldCol = card.column;
          card.column = col.id;
          card.lastMoved = new Date().toISOString();
          if (col.id === 'published' || col.id === 'archived') {
            if (!card.publishedDate) card.publishedDate = new Date().toISOString().slice(0, 10);
          }
          save();
          render();
          toast(`Moved to ${col.title}`);
        }
        draggedId = null;
      }
    });

    filteredCards.forEach(card => {
      const cardEl = buildCardElement(card);
      body.appendChild(cardEl);
    });

    board.appendChild(colEl);
  });

  updateStats();
}

function buildCardElement(card) {
  const el = document.createElement('div');
  el.className = 'card';
  el.draggable = true;
  el.dataset.id = card.id;

  el.addEventListener('dragstart', e => {
    draggedId = card.id;
    el.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  el.addEventListener('dragend', () => {
    el.classList.remove('dragging');
    draggedId = null;
  });

  const typeBadge = TYPE_BADGES[card.type] || { label: card.type, cls: '' };
  const commentsHtml = buildCommentsHtml(card);

  el.innerHTML = `
    <div class="card-actions">
      <button class="btn-icon" onclick="deleteCard('${card.id}')" title="Delete">&times;</button>
    </div>
    <div class="card-title">${esc(card.title)}</div>
    <div class="card-meta">
      <span class="badge ${typeBadge.cls}">${typeBadge.label}</span>
      ${card.draft ? `<span class="badge badge-draft">${esc(card.draft)}</span>` : ''}
    </div>
    ${card.keyword ? `<div class="card-keyword">${esc(card.keyword)}</div>` : ''}
    ${card.slug ? `<div class="card-slug">/${esc(card.slug)}</div>` : ''}
    ${card.publishedDate ? `<div class="card-date">Published: ${esc(card.publishedDate)}</div>` : ''}
    ${card.note ? `<div class="card-note">${esc(card.note)}</div>` : ''}
    ${commentsHtml}
  `;

  return el;
}

function buildCommentsHtml(card) {
  const comments = card.comments || [];
  const hasComments = comments.length > 0;

  let html = `<div class="card-comments" data-card-id="${card.id}">`;

  if (hasComments) {
    comments.forEach((c, i) => {
      html += `<div class="comment">
        <span class="comment-time">${c.time}</span>
        <span class="delete-comment" onclick="deleteComment('${card.id}', ${i})">&times;</span>
        <br><span class="comment-text">${esc(c.text)}</span>
      </div>`;
    });
  }

  html += `<div class="comment-input-wrap">
    <input type="text" placeholder="Add comment..." onkeydown="if(event.key==='Enter')addComment('${card.id}',this.value,this)">
    <button class="btn-sm btn-secondary" onclick="addComment('${card.id}',this.previousElementSibling.value,this.previousElementSibling)">+</button>
  </div>`;

  html += '</div>';
  return html;
}

function addComment(cardId, text, inputEl) {
  if (!text.trim()) return;
  const card = cards.find(c => c.id === cardId);
  if (!card) return;
  if (!card.comments) card.comments = [];
  const now = new Date();
  const time = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
  card.comments.push({ text: text.trim(), time });
  save();
  render();
  toast('Comment added');
}

function deleteComment(cardId, index) {
  const card = cards.find(c => c.id === cardId);
  if (!card || !card.comments) return;
  card.comments.splice(index, 1);
  save();
  render();
}

function deleteCard(id) {
  if (!confirm('Delete this card?')) return;
  cards = cards.filter(c => c.id !== id);
  save();
  render();
  toast('Card deleted');
}

// Filters
function setFilter(filter, el) {
  activeFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  render();
}

// Stats
function updateStats() {
  document.getElementById('stat-total').textContent = cards.length;
  document.getElementById('stat-active').textContent = cards.filter(c => !['published','archived'].includes(c.column)).length;
  document.getElementById('stat-published').textContent = cards.filter(c => c.column === 'published' || c.column === 'archived').length;
}

// Data modal
function openDataModal() {
  document.getElementById('dataModal').classList.add('active');
  document.getElementById('dataTextarea').value = JSON.stringify(cards, null, 2);
}
function closeDataModal() {
  document.getElementById('dataModal').classList.remove('active');
}
function copyData() {
  const ta = document.getElementById('dataTextarea');
  ta.select();
  navigator.clipboard.writeText(ta.value).then(() => toast('Copied to clipboard'));
}
function importData() {
  try {
    const data = JSON.parse(document.getElementById('dataTextarea').value);
    if (!Array.isArray(data)) throw new Error('Must be array');
    cards = data;
    save();
    render();
    closeDataModal();
    toast('Data imported successfully');
  } catch(e) {
    alert('Invalid JSON: ' + e.message);
  }
}

// Add card modal
function openAddModal() {
  document.getElementById('addModal').classList.add('active');
}
function closeAddModal() {
  document.getElementById('addModal').classList.remove('active');
}
function addNewCard() {
  const title = document.getElementById('newTitle').value.trim();
  if (!title) { alert('Title required'); return; }
  const id = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,40) + '-' + Date.now().toString(36);
  const card = {
    id,
    title,
    type: document.getElementById('newType').value,
    column: document.getElementById('newColumn').value,
    keyword: document.getElementById('newKeyword').value.trim() || undefined,
    slug: document.getElementById('newSlug').value.trim() || undefined,
    draft: document.getElementById('newDraft').value.trim() || undefined,
    note: document.getElementById('newNote').value.trim() || undefined,
    comments: [],
    created: new Date().toISOString()
  };
  cards.push(card);
  save();
  render();
  closeAddModal();
  // Reset
  ['newTitle','newKeyword','newSlug','newDraft','newNote'].forEach(id => document.getElementById(id).value = '');
  toast('Card added');
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
});

// Keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay').forEach(o => o.classList.remove('active'));
  }
});

init();
</script>
</body>
</html>
